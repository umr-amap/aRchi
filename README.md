# aRchi

-   [The package](#the-package)
-   [Install aRchi](#install-archi)

## The package

An r package that provides a set of tools to manipulate, visualize and
compute metrics from quantitative structural models of trees (i.e., ‘QSMs’). It can be used in various contexts of forest ecology
(i.e. biomass estimation) and tree architecture (i.e. architectural
metrics). The package is based on a new S4 class called ‘aRchi’.

### The class aRchi

All the function allowing visualization, metrics computation or QSM
modification needs an object of class aRchi as input. A class archi can
be built using the *build_aRchi()* function.

This Class contains five slots:

1.  The QSM of a tree. See the next section for more details.
2.  The point cloud that was used to generate the QSM. It can be
    imported as XYZ data.frame/data.table or a LAS.
3.  The paths. It can be constructed using the *Make_path()* function
    and is needed for several metric computations and QSM modifications.
4.  The nodes. It can be constructed using the *Make_Node()* function
    and is required only for some metrics (see function
    *WBEparameters()* or *LeonardoRatio()* for example)
5.  The operations. It records all the operations that have been made on
    the aRchi object (QSM modifications, paths and node construction…)

### Import and build QSMs in aRchi

The *read_QSM()* function provides methods to import QSMs generated by some of the most commonly used QSM models (treeQSM (last version and even .mat file),
SimpleTree, SimpleForest and pypeTree). The imported QSMs are automatically converted into a common QSM format defined in the aRchi class.

Since version 2.1.0 of the package, aRchi also provides the
possibility to generate QSMs. To do so, three functions are provided :

-   *skeletonize_pc()* allows to build a skeleton.
-   *smooth_skeleton()*.
-   *add_radius()* computes the radius of each cylinder based on the point
    distance to the skeleton.

The aRchi's QSM method was designed to build very detailed QSMs from
high-quality TLS scans. However, it also allows us to quickly reconstruct
the coarse architecture of large point clouds of lower quality. A basic
explanation of QSMs building in aRchi is shown in the figure below.
<img src="figure_QSM.png" width="80%"/>

aRchi also allows adding the non-reconstructed axes to a QSM using the *add_non_reconstructed()* function.

### Tree topology in aRchi

aRchi provides the ability to compute a range of topological information from QSMs:

-   *build_aRchi()* and *skeletonize()* include the computation of a
    basic tree topology at different levels of the tree architecture
    (cylinders, nodes, axes and branching orders).
-   *segment_annual_shoots()* segments annual shoots in QSM of trees
    that exhibit acrotonic growth patterns.
-   *add_physiological_ages()* class annual shoots into *N*
    physiological ages based on their length.
-   *compute_AO()* automatically identify the dominant axis of a tree
    based on the information available in the QSM.
    <img src="topology.png" width="80%"/>

### Visualization and interaction (some tips)

It is possible to visualize the QSM with or without the point cloud and
show only the skeleton or the whole QSM (i.e. with cylinder volume) in
a 3D interactive window using the function *plot()*. Different levels of
organization such as branch order, segment or cylinder can be colorized.

3d plot with Branch order colourized or the QSM with point cloud:

<img src="141_plot_branch_order_pc.JPG" width="50%"/>

Some function allows modifying the QSM (e.g *cleanQSM()*,
*TruncateQSM()*, *simplify_skeleton()*) and propose a visualization of
the results.

The retained part is in red and the removed part is in white -- obtained with
*TruncateQSM()*:

<img src="141_truncate_QSM.JPG" width="40%"/>

It is also possible to select a part of the QSM in a 3D interactive
window by following the instruction of the function *selectinQSM_3d()*.
It allows selecting different levels of organization (cylinder, branch,
segment, node….) and returns a table of the selected part of the QSM with all the information available. For example, If the biomass and
mechanical constraints have been computed using the *Compute_mf()* function, the returned table will contain the biomass and moment of force of all the cylinders/segments/nodes… selected.

Select a part of the QSM by following the *selectinQSM_3d()* function
instruction:

<img src="selectin3d.jpg" width="50%"/>

All the characteristics of the selected part are returns:

<img src="select_in3d_3.JPG" width="100%"/>

For more information on some metrics such as WBE parameters
(*WBEparameters()*), Dominance apical index (*DAI()*), fork rate
(*ForkRate()*) or branch angle (*BranchAngle()*) see
[article](https://doi.org/10.1111/1365-2435.13678).

## Install aRchi

The latest released version from CRAN:

``` r
install.packages("aRchi")
```

The latest version from Github (in development):

``` r
install.packages("remotes")
remotes::install_github('umr-amap/aRchi')
```

To use it :

``` r
library("aRchi")
```
